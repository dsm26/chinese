let flashcards = [];
let currentIndex = 0;
let seenIndices = [];    // full history of shown card indices
let historyPointer = 0;  // current position in history

function showCard() {
  if (flashcards.length === 0) return;
  const card = flashcards[currentIndex];
  const showFirst = document.getElementById("showFirstSelect").value;
  const showAnswer = document.getElementById("showAnswerToggle").checked;
  const showPinyin = document.getElementById("showPinyinToggle").checked;

  let question = "", answer = "", pinyin = "";

  if (showFirst === "english") {
    question = card.english;
    answer = card.chinese;
    pinyin = card.pinyin;
  } else {
    question = card.chinese;
    pinyin = card.pinyin;
    answer = card.english;
  }

  document.getElementById("question").textContent = question;
  document.getElementById("answer").textContent = showAnswer ? answer : "";
  document.getElementById("pinyin").textContent =
    (showPinyin && (showFirst === "chinese" || showAnswer)) ? pinyin : "";
}

function nextCard() {
  if (flashcards.length === 0) return;

  const randomMode = document.getElementById("randomToggle").checked;

  if (historyPointer < seenIndices.length - 1) {
    // Move forward in history
    historyPointer++;
    currentIndex = seenIndices[historyPointer];
  } else {
    // At end of history: pick new card
    if (randomMode) {
      const unseen = flashcards.map((_, i) => i).filter(i => !seenIndices.includes(i));
      if (unseen.length === 0) {
        // All seen, allow repeats
        currentIndex = Math.floor(Math.random() * flashcards.length);
      } else {
        const randIndex = unseen[Math.floor(Math.random() * unseen.length)];
        currentIndex = randIndex;
      }
    } else {
      currentIndex = (currentIndex + 1) % flashcards.length;
    }
    // Add to history
    seenIndices.push(currentIndex);
    historyPointer = seenIndices.length - 1;
  }

  showCard();
}

function prevCard() {
  if (historyPointer <= 0) return; // can't go back further
  historyPointer--;
  currentIndex = seenIndices[historyPointer];
  showCard();
}
