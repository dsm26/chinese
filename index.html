<script>
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCDpSuFzdccJJsBrxvG5x9YxkQnVrT4O9N6-Ac4N50l3K0mKrfRn36R2xndR9twPyBQVr8IoEW6vDf/pub?gid=0&single=true&output=csv";
  const cacheKey = "flashcards-cache-v1";

  let flashcards = [];
  let currentIndex = 0;

  // New memory variables
  let seenIndices = [];
  let historyPointer = -1;

  function setStatus(message) {
    document.getElementById("status").textContent = message;
  }

  function setFooter(fetchTimeMs = null) {
    const footer = document.getElementById("footer");
    if (flashcards.length > 0) {
      let msg = `Total vocabulary terms: ${flashcards.length}`;
      if (fetchTimeMs !== null) msg += ` (fetch: ${fetchTimeMs} ms)`;
      footer.textContent = msg;
    } else {
      footer.textContent = "";
    }
  }

  document.getElementById("csvLink").href = sheetUrl;

  async function fetchCSV() {
    const startTime = performance.now();
    const res = await fetch(sheetUrl);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    const text = await res.text();
    const duration = Math.round(performance.now() - startTime);
    return {data: parseCSV(text), duration};
  }

  function parseCSV(text) {
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows[0];
    const dataRows = rows.slice(1);
    return dataRows.map(row => {
      let obj = {};
      headers.forEach((h, i) => obj[h.trim().toLowerCase()] = row[i]?.trim());
      if (obj.pinyin) {
        obj.pinyin = obj.pinyin.replace(/^\(|\)$/g, "").trim();
      }
      return obj;
    });
  }

  async function loadData(fromCache = true) {
    if (fromCache) {
      let cached = localStorage.getItem(cacheKey);
      if (cached) {
        try {
          flashcards = JSON.parse(cached);
          resetHistory();
          showCard();
          setStatus("Loaded from cache");
          setFooter();
          return;
        } catch (e) {
          console.warn("Cache parse failed:", e);
        }
      }
    }
    await reloadData();
  }

  async function reloadData() {
    try {
      setStatus("Fetching data...");
      const {data, duration} = await fetchCSV();
      flashcards = data;
      localStorage.setItem(cacheKey, JSON.stringify(flashcards));
      resetHistory();
      showCard();
      setStatus("Fetched fresh from Google Sheets");
      setFooter(duration);
    } catch (err) {
      console.error(err);
      setStatus("❌ Failed to fetch data (blocked or network error)");
      flashcards = [];
      resetHistory();
      document.getElementById("question").textContent = "Error loading flashcards";
      document.getElementById("answer").textContent = "";
      document.getElementById("pinyin").textContent = "";
      setFooter();
    }
  }

  function clearCache() {
    localStorage.removeItem(cacheKey);
    setStatus("Cache cleared — reload to fetch fresh data");
    setFooter();
  }

  function resetHistory() {
    currentIndex = 0;
    seenIndices = [currentIndex];
    historyPointer = 0;
  }

  function showCard() {
    if (flashcards.length === 0) return;

    const card = flashcards[currentIndex];
    const showFirst = document.getElementById("showFirstSelect").value;
    const showAnswer = document.getElementById("showAnswerToggle").checked;
    const showPinyin = document.getElementById("showPinyinToggle").checked;

    let question = "", answer = "", pinyin = "";

    if (showFirst === "english") {
      question = card.english;
      answer = card.chinese;
      pinyin = card.pinyin;
    } else {
      question = card.chinese;
      pinyin = card.pinyin;
      answer = card.english;
    }

    document.getElementById("question").textContent = question;
    document.getElementById("answer").textContent = showAnswer ? answer : "";
    document.getElementById("pinyin").textContent =
      (showPinyin && (showFirst === "chinese" || showAnswer)) ? pinyin : "";
  }

  function nextCard() {
    if (flashcards.length === 0) return;

    const randomMode = document.getElementById("randomToggle").checked;

    if (historyPointer < seenIndices.length - 1) {
      // Move forward through history
      historyPointer++;
      currentIndex = seenIndices[historyPointer];
    } else {
      // Pick a new card
      if (randomMode) {
        let unseen = flashcards.map((_, i) => i).filter(i => !seenIndices.includes(i));
        if (unseen.length === 0) {
          // all seen, allow repeats
          currentIndex = Math.floor(Math.random() * flashcards.length);
        } else {
          currentIndex = unseen[Math.floor(Math.random() * unseen.length)];
        }
      } else {
        currentIndex = (currentIndex + 1) % flashcards.length;
      }
      seenIndices.push(currentIndex);
      historyPointer = seenIndices.length - 1;
    }
    showCard();
  }

  function prevCard() {
    if (flashcards.length === 0) return;
    if (historyPointer > 0) {
      historyPointer--;
      currentIndex = seenIndices[historyPointer];
      showCard();
    }
  }

  document.getElementById("showAnswerToggle").addEventListener("change", showCard);
  document.getElementById("showFirstSelect").addEventListener("change", showCard);
  document.getElementById("showPinyinToggle").addEventListener("change", showCard);

  loadData(true);
</script>
